<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="js/library/phaser.js"></script>
    <title>Title</title>
</head>
<body>
    <div id="container"></div>

    <script type="text/javascript">
        var game = new Phaser.Game(512, 600, Phaser.AUTO, 'container', {
            preload: preload,
            create: create,
            update: update
            //render: render
        });

        function preload() {
            game.load.image('stage01BG', './assets/Background/stage01blue.png');
            game.load.image('sanaeHurtbox', './assets/Player/playerHurtbox.png');
            game.load.image('sanae', './assets/Player/playerStand.png');
            game.load.image('aimGruntShot', './assets/Enemy/enemyBullets/aimGruntShot.png');
            game.load.image('straightGruntShot', './assets/Enemy/enemyBullets/straightGruntShot.png');
            game.load.image('rotateGruntShot', './assets/Enemy/enemyBullets/rotateGruntShot.png');
            game.load.image('gruntRotate', './assets/Enemy/gruntRotate.png')
            game.load.image('gruntStraightRed', './assets/Enemy/gruntStraightRed.png');
            game.load.image('gruntStraightBlue', './assets/Enemy/gruntStraightBlue.png');
            game.load.image('gruntAimRed', './assets/Enemy/gruntAimRed.png');
            game.load.image('gruntAimBlue', './assets/Enemy/gruntAimBlue.png');
            game.load.image('singlePrimary', './assets/Player/playerShotA.png');
            game.load.image('doublePrimary', './assets/Player/playerShotB.png');
            game.load.image('spreadPrimary', './assets/Player/secondaryShotALT.png');
        }

        var playerStats = {
            score: 0,
            graze: 0,
            lives: 3,
            bomb: 2
        };
        var lifeText;
        var gameOverText;
        var gameTimer = 0;
        const playerPhysicsStats = {
            normalVelocity: 275,
            focusVelocity: 150
        };
        const enemyStats = {
            aimGruntHP: 10,
            straightGruntHP: 16,
            rotateGruntHP: 24,
            gruntXvelocity: 50,
            gruntYvelocity: 50,
            gruntStraightVelocity: 100
        };
        const enemyWeapon = {
            gruntBulletSpeed: 250,
            gruntBulletFireRate: 500,
            gruntBulletAngleOffset: 90,
            aimGruntBulletAngleOffset: 0,
            gruntStraightBulletSpeed: 150, //100
            gruntStraightBulletFireRate: 850, //16 is the lowest and quickest possible
            gruntRotateBulletSpeed: 150,
            gruntRotateBulletFireRate: 100 // 16 original
        };
        const weaponStats = {
            weapon1BulletSpeed: 850,
            weapon1BulletFireRate: 90,
            weapon1BulletAngleOffSet: 90,
            weapon1Damage: 4,
            weapon2Damage: 6
        };
        var rotateGruntTimers = [];

        var bg;
        var weapon1;
        var weapon2;
        var playerHurtbox;
        var playerSprite;
        var playerDeathSignal;
        var cursors;
        var fireButton;
        var focusButton;
        var aimGrunts;
        var straightGrunts;
        var rotateGrunts;

        // Enemy Weapons
        var aimGruntWeapons = [];
        var aimGruntWeaponDIS = []; // Stands for Death Index Signals
        var rotateGruntWeapons = [];
        var rotateGruntWeaponDIS = [];
        var straightGruntWeapons = [];
        var straightGruntWeaponDIS = [];


        // weapon.Bullets is a group
        function create() {
            // Scrolling Background
            //bg = game.add.tileSprite(0, 0, 512, 600, 'stage01BG');

            // ___WEAPONS___

            // Single Shot
            weapon1 = game.add.weapon(30, 'singlePrimary');
            weapon1.bulletKillType = Phaser.Weapon.KILL_WORLD_BOUNDS;
            weapon1.bulletAngleOffset = weaponStats.weapon1BulletAngleOffSet;
            weapon1.bulletSpeed = weaponStats.weapon1BulletSpeed;
            weapon1.fireRate = weaponStats.weapon1BulletFireRate;
            weapon1.bullets.forEach(function(bullet) {
                bullet.damageAmount = weaponStats.weapon1Damage;
            });

            // Double Shot
            weapon2 = game.add.weapon(30, 'doublePrimary');
            weapon2.bulletKillType = Phaser.Weapon.KILL_WORLD_BOUNDS;
            weapon2.bulletAngleOffset = 90;
            weapon2.bulletSpeed = 850;
            weapon2.fireRate = 90;
            weapon2.bullets.forEach(function(bullet) {
               bullet.damageAmount = 5;
            });

            // Enemies
            aimGrunts = game.add.group();
            aimGrunts.enableBody = true;
            aimGrunts.physicsBodyType = Phaser.Physics.ARCADE;

            straightGrunts = game.add.group();
            straightGrunts.enableBody = true;
            straightGrunts.physicsBodyType = Phaser.Physics.ARCADE;

            rotateGrunts = game.add.group();
            rotateGrunts.enableBody = true;
            rotateGrunts.physicsBodyType = Phaser.Physics.ARCADE;
            /*for (var i = 0; i < 5; i++) {
                var g = grunts.create(game.world.randomX, game.world.randomY, 'enemyTest');
                g.body.immovable = true;
            }
            grunts.setAll('anchor.x', 0.5);
            grunts.setAll('anchor.y', 0.5);
            grunts.setAll('outOfBoundsKill', true);
            grunts.setAll('checkWorldBounds', true);
            grunts.setAll('health', enemyStats.aimGruntHP);

            grunts.forEach(function(enemy) {
                enemy.damageAmount = 10;
            });*/

            // Enemy Bullets
            /*gruntBullets = game.add.weapon(10, 'gruntShot');
            gruntBullets.bulletKillType = Phaser.Weapon.KILL_WORLD_BOUNDS;
            gruntBullets.bulletAngleOffset = enemyWeapon.gruntBulletAngleOffset;
            gruntBullets.bulletSpeed = enemyWeapon.gruntBulletSpeed;
            gruntBullets.fireRate = enemyWeapon.gruntBulletFireRate;
            gruntBullets.createBullets(2, 'gruntShot', grunts);
            gruntBullets.bullets.forEach(function(bullet) {
                bullet.damageAmount = 1;
            });*/
            /*gruntBullets = game.add.group();
            gruntBullets.enableBody = true;
            gruntBullets.physicsBodyType = Phaser.Physics.ARCADE;
            gruntBullets.createMultiple(100, 'gruntShot');
            gruntBullets.setAll('anchor.x', 0.5);
            gruntBullets.setAll('anchor.y', 0.5);
            gruntBullets.setAll('outOfBoundsKill', true);
            gruntBullets.setAll('checkWorldBounds', true);*/


            // Player
            playerHurtbox = this.add.sprite((game.world.width/2), game.world.height - 150, 'sanaeHurtbox');
            playerHurtbox.health = 3;
            playerHurtbox.anchor.setTo(0.5);
            playerSprite = this.add.sprite((game.world.width/2), game.world.height - 150, 'sanae');
            playerSprite.health = 3;
            playerSprite.anchor.setTo(0.5);


            game.physics.arcade.enable(playerHurtbox);
            game.physics.arcade.enable(playerSprite);
            playerHurtbox.body.collideWorldBounds = true;
            playerHurtbox.body.setCircle(6, 1);
            playerSprite.body.collideWorldBounds = true;
            console.log('hitbox x: ' + playerHurtbox.body.x + ', y: ' + playerHurtbox.body.y + ', ' + 'offset' + playerHurtbox.offsetX + ', ' + playerHurtbox.offsetY);
            console.log('sprite x: ' + playerSprite.body.x + ', y: ' + playerSprite.body.y + ', ' + 'offset' + playerSprite.offsetX + ', ' + playerSprite.offsetY);

            // Weapon Tracking
            // -- Weapon on player
            weapon1.trackSprite(playerSprite, 0, -(playerSprite.height/2 + 27));
            weapon2.trackSprite(playerSprite, 0, -(playerSprite.height/2 + 27));

            // Setting Controls
            cursors = this.input.keyboard.createCursorKeys();
            fireButton = this.input.keyboard.addKey(Phaser.KeyCode.Z);
            focusButton = this.input.keyboard.addKey(Phaser.KeyCode.SHIFT);

            // Game Text
                // Lives
            lifeText = game.add.text(10, game.world.height - 30, 'Lives: ' + playerHurtbox.health, { font: '20px Arial', fill: '#FFF' });
            lifeText.render = function() {
                lifeText.text = 'Lives: ' + Math.max(playerHurtbox.health, 0);
            };
                // Game Over
            gameOverText = game.add.text(game.world.centerX, game.world.centerY, 'GAME OVER\nTo restart, refresh the browser', { font: '30px Arial', fill: '#fff'});
            gameOverText.anchor.setTo(0.5);
            gameOverText.visible = false;

            // enemy testing
            //spawnAimGrunt(game.world.randomX, 100, 0, enemyStats.gruntYvelocity, 'gruntAimBlue', 'gruntShot');
            //spawnAimGrunt(game.world.randomX, 200, 0, enemyStats.gruntYvelocity, 'gruntAimRed', 'gruntShot');
            //spawnAimGrunt(game.world.randomX, 50, -(enemyStats.gruntXvelocity), enemyStats.gruntYvelocity, 'gruntAimBlue', 'gruntShot');
            //spawnAimGrunt(game.world.randomX, 50, enemyStats.gruntXvelocity, enemyStats.gruntYvelocity, 'gruntAimRed', 'gruntShot');
            //spawnRotateGrunt(game.world.randomX, 100, 0, 50, 'gruntRotate', 'gruntShot');
            //spawnRotateGrunt(game.world.randomX, 100, 0, 50, 'gruntRotate', 'gruntShot');
            //spawnStraightGrunt(0, 50, enemyStats.gruntXvelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot');
            //spawnStraightGrunt(50, 150, enemyStats.gruntXvelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot');

            //spawnStraightGrunt(game.world.width - 100, 50, 0, 0, 'gruntStraightRed', 'straightGruntShot');
            //spawnStraightGrunt(100, 50, 0, 0, 'gruntStraightBlue', 'straightGruntShot');
            //spawnAimGrunt(250, 50, 0, 0, 'gruntAimRed', 'aimGruntShot');
            //spawnAimGrunt(350, 50, 0, 0, 'gruntAimBlue', 'aimGruntShot');
            //spawnRotateGrunt(200, 250, 0, 0, 'gruntRotate', 'rotateGruntShot');

            //spawnStraightGrunt(game.world.width, 50, -enemyStats.gruntXvelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot');
            //spawnStraightGrunt(game.world.width, 110, -enemyStats.gruntXvelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot');
            //spawnStraightGrunt(game.world.width, 170, -enemyStats.gruntXvelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot');
            //spawnStraightGrunt(game.world.width, 230, -enemyStats.gruntXvelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot');
            //spawnStraightGrunt(game.world.width, 150, -enemyStats.gruntXvelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot');

        }

        function update() {
            playerSprite.sendToBack();
            playerHurtbox.sendToBack();
            //bg.sendToBack();
            aimGrunts.callAll('bringToTop');
            straightGrunts.callAll('bringToTop');
            rotateGrunts.callAll('bringToTop');
            playerHurtbox.body.velocity.x = 0;
            playerHurtbox.body.velocity.y = 0;
            playerSprite.body.velocity.x = 0;
            playerSprite.body.velocity.y = 0;

            // Collision Checking
                // aimGrunts
            game.physics.arcade.overlap(playerHurtbox, aimGrunts, playerCollide, null, this);
            game.physics.arcade.overlap(weapon1.bullets, aimGrunts, bulletCollide, null, this);
            game.physics.arcade.overlap(weapon2.bullets, aimGrunts, bulletCollide, null, this);

                // straightGrunts
            game.physics.arcade.overlap(playerHurtbox, straightGrunts, playerCollide, null, this);
            game.physics.arcade.overlap(weapon1.bullets, straightGrunts, bulletCollide, null, this);

                // rotateGrunts
            game.physics.arcade.overlap(playerHurtbox, rotateGrunts, playerCollide, null, this);
            game.physics.arcade.overlap(weapon1.bullets, rotateGrunts, bulletCollide, null, this);

            // Check Enemy Bullet Collisions/Overlap
            checkGruntBulletOverlap(aimGruntWeapons);
            checkGruntBulletOverlap(straightGruntWeapons);
            checkGruntBulletOverlap(rotateGruntWeapons);

            checkControls();

            // Enemy Shooting
            gruntFireSprite(aimGrunts, aimGruntWeapons, aimGruntWeaponDIS);
            gruntStraightFire(straightGrunts, straightGruntWeapons, straightGruntWeaponDIS);
            gruntRotateFire(rotateGrunts, rotateGruntWeapons, rotateGruntWeaponDIS);

            // Scroll the bg
            //bg.tilePosition.y += 2;
            if (!playerHurtbox.alive && gameOverText.visible === false) {
                gameOverText.visible = true;
                var fadeInGameOver = game.add.tween(gameOverText);
                fadeInGameOver.to({alpha: 0.2}, 1000, Phaser.Easing.Quintic.Out, false, 0, -1, true);
                fadeInGameOver.start();
            }
            startStageOne();
            gameTimer++;
        }

        // DEBUGGING
        function render() {
            game.debug.body(playerHurtbox);
            aimGrunts.forEachAlive(renderGroup, this, 'rgba(255, 0, 0, 0.4)');
            straightGrunts.forEachAlive(renderGroup, this, 'rgba(255, 0, 0, 0.4)');
            rotateGrunts.forEachAlive(renderGroup, this, 'rgba(255, 0, 0, 0,4)');
            weapon1.bullets.forEachAlive(renderGroup, this, 'rgba(0, 0, 255, 0.4)');
            weapon2.bullets.forEachAlive(renderGroup, this, 'rgba(0, 0, 255, 0.4)');
        }

        function renderGroup(child, strColor) {
            game.debug.body(child, strColor);
        }
        // End DEBUGGING

        // Control Actions
        function checkControls() {
            if (focusButton.isDown) {
                playerHurtbox.bringToTop();
            }

            if (cursors.up.isDown && !focusButton.isDown) {
                if (playerSprite.body.y <= 0) {
                    playerHurtbox.body.velocity.y = 0;
                    playerHurtbox.body.y = 16;
                }
                else {
                    playerHurtbox.body.velocity.y = -(playerPhysicsStats.normalVelocity);
                    playerSprite.body.velocity.y = -(playerPhysicsStats.normalVelocity);
                }
            }
            else if (cursors.up.isDown && focusButton.isDown) {
                playerHurtbox.bringToTop();
                if (playerSprite.body.y <= 0) {
                    playerHurtbox.body.velocity.y = 0;
                    playerHurtbox.body.y = 16;

                }
                else {
                    playerHurtbox.body.velocity.y = -(playerPhysicsStats.focusVelocity);
                    playerSprite.body.velocity.y = -(playerPhysicsStats.focusVelocity);
                }
            }
            else if (cursors.down.isDown && !focusButton.isDown) {
                if (playerSprite.body.y >= 556) {
                    playerHurtbox.body.velocity.y = 0;
                    playerHurtbox.body.y = 572;
                }
                else {
                    playerHurtbox.body.velocity.y = playerPhysicsStats.normalVelocity;
                    playerSprite.body.velocity.y = playerPhysicsStats.normalVelocity;
                }
            }
            else if (cursors.down.isDown && focusButton.isDown) {
                playerHurtbox.bringToTop();
                if (playerSprite.body.y >= 556) {
                    playerHurtbox.body.velocity.y = 0;
                    playerHurtbox.body.y = 572;
                }
                else {
                    playerHurtbox.body.velocity.y = playerPhysicsStats.focusVelocity;
                    playerSprite.body.velocity.y = playerPhysicsStats.focusVelocity;
                }
            }

            if (cursors.left.isDown && !focusButton.isDown) {
                if (playerSprite.body.x <= 0) {
                    playerHurtbox.body.velocity.x = 0;
                    playerHurtbox.body.x = 6;
                }
                else {
                    playerHurtbox.body.velocity.x = -(playerPhysicsStats.normalVelocity);
                    playerSprite.body.velocity.x = -(playerPhysicsStats.normalVelocity);
                }
            }
            else if (cursors.left.isDown && focusButton.isDown) {
                playerHurtbox.bringToTop();
                if (playerSprite.body.x <= 0) {
                    playerHurtbox.body.velocity.x = 0;
                    playerHurtbox.body.x = 6;
                }
                else {
                    playerHurtbox.body.velocity.x = -(playerPhysicsStats.focusVelocity);
                    playerSprite.body.velocity.x = -(playerPhysicsStats.focusVelocity);
                }
            }
            else if (cursors.right.isDown && !focusButton.isDown) {
                if (playerSprite.body.x >= 486) {
                    playerHurtbox.body.velocity.x = 0;
                    playerHurtbox.body.x = 492;
                }
                else {
                    playerHurtbox.body.velocity.x = playerPhysicsStats.normalVelocity;
                    playerSprite.body.velocity.x = playerPhysicsStats.normalVelocity;
                }
            }
            else if (cursors.right.isDown && focusButton.isDown) {
                playerHurtbox.bringToTop();
                if (playerSprite.body.x >= 486) {
                    playerHurtbox.body.velocity.x = 0;
                    playerHurtbox.body.x = 492;
                }
                else {
                    playerHurtbox.body.velocity.x = playerPhysicsStats.focusVelocity;
                    playerSprite.body.velocity.x = playerPhysicsStats.focusVelocity;
                }
            }

            // Check amount of P and then fire appropriate weapon
            if (playerHurtbox.alive && fireButton.isDown) {
                weapon1.fire();
            }
        }

        function playerCollide(player, enemy) {
            console.log('enemy collide');
            player.damage(enemy.damageAmount);
            playerSprite.damage(enemy.damageAmount);
            lifeText.render();
            player.body.x = 250;
            player.body.y = 443.5;
            playerSprite.body.x = 243;
            playerSprite.body.y = 428;
            //var tempHp = player.health;
            //player.reset(game.world.width / 2, game.world.height - 150, player.health);
            console.log(player.health);
            console.log(playerSprite.health);
            if (aimGruntWeapons.length > 0) {
                for (var i = 0; i < aimGruntWeapons.length; i++) {
                    aimGruntWeapons[i].killAll();
                }
            }
            if (straightGruntWeapons.length > 0) {
                for (var j = 0; j < straightGruntWeapons.length; j++) {
                    //straightGruntWeapons[straightGruntWeaponDIS[i]].bullets.callAllExists('killAll', true);
                    straightGruntWeapons[j].killAll();
                }
            }
            if (rotateGruntWeapons.length > 0) {
                for (var k = 0; k < rotateGruntWeapons.length; k++) {
                    //rotateGruntWeapons[rotateGruntWeaponDIS[i]].bullets.callAllExists('killAll', true);
                    rotateGruntWeapons[k].killAll();

                }
            }
            /*if (playerDeathSignal.callCount < playerStats.lives && !player.alive) {
                player.revive(1);
                playerSprite.revive(1);
                playerSprite.sendToBack();
                player.sendToBack();
                playerSprite.moveUp();
                player.moveUp();
            }*/
            // game over screen here
        }

        // when sprite dies, its bullets linger and will still deal damage
        function bulletCollide(bullet, sprite) {
            if (bullet !== undefined) {
                bullet.kill();
                sprite.damage(bullet.damageAmount);
            }
        }

        function checkGruntBulletOverlap(gruntWeaponArray) {
            // if there is exists a grunt weapon in the aimGruntWeapons array (means that an enemy has spawned as well), then check collision for each weapon
            if (gruntWeaponArray.length > 0) {
                for (var i = 0; i < gruntWeaponArray.length; i++) {
                    //since its a group vs sprite, then first argument to gruntShotCollide is the sprite
                    if (gruntWeaponArray[i] != null) {
                        game.physics.arcade.overlap(gruntWeaponArray[i].bullets, playerHurtbox, gruntShotCollide, null, this);
                    }
                }
            }
        }

        function gruntShotCollide(player, bullet) {
            console.log('grunt bullet collide');
            player.damage(bullet.damageAmount);
            playerSprite.damage(bullet.damageAmount);
            lifeText.render();
            player.body.x = 250;
            player.body.y = 443.5;
            playerSprite.body.x = 243;
            playerSprite.body.y = 428;
            console.log(player.health);
            console.log(playerSprite.health);
            if (aimGruntWeapons.length > 0) {
                for (var i = 0; i < aimGruntWeapons.length; i++) {
                    aimGruntWeapons[i].killAll();
                }
            }
            if (straightGruntWeapons.length > 0) {
                for (var i = 0; i < straightGruntWeapons.length; i++) {
                    //straightGruntWeapons[straightGruntWeaponDIS[i]].bullets.callAllExists('killAll', true);
                    straightGruntWeapons[i].killAll();
                }
            }
            if (rotateGruntWeapons.length > 0) {
                for (var i = 0; i < rotateGruntWeapons.length; i++) {
                    //rotateGruntWeapons[rotateGruntWeaponDIS[i]].bullets.callAllExists('killAll', true);
                    rotateGruntWeapons[i].killAll();

                }
            }
            // start gameover state here
        }

        // perfect now
        function spawnAimGrunt(x, y, velocityX, velocityY, spriteName, weaponName) {
            var newGrunt = aimGrunts.create(x, y, spriteName);
            newGrunt.anchor.setTo(0.5);
            newGrunt.outOfBoundsKill = true;
            newGrunt.checkWorldBounds = true;
            newGrunt.setHealth(enemyStats.aimGruntHP);
            newGrunt.damageAmount = 1;
            newGrunt.body.immovable = true;
            newGrunt.body.velocity.x = velocityX;
            newGrunt.body.velocity.y = velocityY;

            var newWeapon = game.add.weapon(30, weaponName);
            newWeapon.bulletSpeed = enemyWeapon.gruntBulletSpeed;
            newWeapon.bulletAngleOffset = enemyWeapon.aimGruntBulletAngleOffset;
            newWeapon.fireRate = enemyWeapon.gruntBulletFireRate;
            newWeapon.bullets.forEach(function(bullet) {
                bullet.damageAmount = 1;
            });
            newWeapon.trackSprite(newGrunt, 0, 0);
            aimGruntWeapons.push(newWeapon);
            aimGruntWeaponDIS.push(newGrunt.events.onKilled.add(checkGruntKill, this, this, aimGrunts));
        }

        // perfect now
        function spawnRotateGrunt(x, y, velocityX, velocityY, spriteName, weaponName) {
            var newGrunt = rotateGrunts.create(x, y, spriteName);
            newGrunt.anchor.setTo(0.5);
            newGrunt.outOfBoundsKill = true;
            newGrunt.checkWorldBounds = true;
            newGrunt.setHealth(enemyStats.rotateGruntHP);
            newGrunt.damageAmount = 1;
            newGrunt.body.immovable = true;
            newGrunt.body.velocity.x = velocityX;
            newGrunt.body.velocity.y = velocityY;

            var newWeapon = game.add.weapon(80, weaponName);
            newWeapon.bulletSpeed = enemyWeapon.gruntRotateBulletSpeed;
            newWeapon.bulletAngleOffset = enemyWeapon.gruntBulletAngleOffset;
            newWeapon.fireRate = enemyWeapon.gruntRotateBulletFireRate;
            newWeapon.bullets.forEach(function(bullet) {
                bullet.damageAmount = 1;
            });
            newWeapon.trackSprite(newGrunt, 0, 0);
            rotateGruntWeapons.push(newWeapon);
            rotateGruntWeaponDIS.push(newGrunt.events.onKilled.add(checkGruntKill, this, this, rotateGrunts));
            rotateGruntTimers.push(0);
        }

        function spawnStraightGrunt(x, y, velocityX, velocityY, spriteName, weaponName) {
            var newGrunt = straightGrunts.create(x, y, spriteName);
            newGrunt.anchor.setTo(0.5);
            newGrunt.outOfBoundsKill = true;
            newGrunt.checkWorldBounds = true;
            newGrunt.setHealth(enemyStats.straightGruntHP);
            newGrunt.damageAmount = 1;
            newGrunt.body.immovable = true;
            newGrunt.body.velocity.x = velocityX;
            newGrunt.body.velocity.y = velocityY;

            var newWeapon = game.add.weapon(30, weaponName);
            newWeapon.bulletSpeed = enemyWeapon.gruntStraightBulletSpeed;
            newWeapon.bulletAngleOffset = enemyWeapon.gruntBulletAngleOffset;
            newWeapon.fireRate = enemyWeapon.gruntStraightBulletFireRate;
            newWeapon.bullets.forEach(function(bullet) {
                bullet.damageAmount = 1;
            });
            newWeapon.trackSprite(newGrunt, 0, 0);
            straightGruntWeapons.push(newWeapon);
            straightGruntWeaponDIS.push(newGrunt.events.onKilled.add(checkGruntKill, this, this, straightGrunts));
        }

        // aimGruntFire
        function gruntFireSprite(gruntGroup, gruntWeaponArray, gruntWeaponDIS) {
            // if player is a live and aimGruntWeapons exist shoot every weapon at the player
            if (playerHurtbox.alive && gruntWeaponArray.length > 0) {
                for (var i = 0; i < gruntWeaponArray.length; i++) {
                    // shoot at player when self is healthy and its onKilled signal hasn't been called
                    if (gruntGroup.getChildAt(i).health > 0 && gruntWeaponDIS[i].callCount <= 0) {
                        gruntWeaponArray[i].fireAtSprite(playerHurtbox);
                    }
                }
            }
        }

        // straightGruntFire
        function gruntStraightFire(gruntGroup, gruntWeaponArray, gruntWeaponDIS) {
            if (playerHurtbox.alive && gruntWeaponArray.length > 0) {
                for (var i = 0; i < gruntWeaponArray.length; i++) {
                    // shoot at player when self is healthy and its onKilled signal hasn't been called
                    if (gruntGroup.getChildAt(i).health > 0 && gruntWeaponDIS[i].callCount <= 0) {
                        //gruntWeaponArray[i].fire(null, gruntGroup.getChildAt(i).body.x + 22, game.world.height);
                        gruntWeaponArray[i].fireAngle = 90;
                        //gruntWeaponArray[i].bullets.setAll('body.velocity.x', 0);
                        gruntWeaponArray[i].fire();
                    }
                }
            }
        }

        // rotateGruntFire
        function gruntRotateFire(gruntGroup, gruntWeaponArray, gruntWeaponDIS) {
            if (playerHurtbox.alive && gruntWeaponArray.length > 0) {
                for (var i = 0; i < gruntWeaponArray.length > 0; i++) {
                    if (gruntGroup.getChildAt(i).health > 0 && gruntWeaponDIS[i].callCount <= 0) {
                        //gruntWeaponArray[i].fire(null, gruntGroup.getChildAt(i).body.x + 22, game.world.height);
                        //console.log('first fire x velocity: ' + gruntWeaponArray[i].bullets.getFirstAlive().body.velocity.x);
                        if (rotateGruntTimers[i] == 0) {
                            gruntWeaponArray[i].fire();
                            rotateGruntTimers[i] = game.time.now + gruntWeaponArray[i].fireRate;
                        }
                        if (game.time.now > rotateGruntTimers[i]) {
                            gruntWeaponArray[i].fire();
                            rotateGruntTimers[i] = game.time.now + gruntWeaponArray[i].fireRate;
                            gruntWeaponArray[i].fireAngle += 25;
                        }
                    }
                }
            }
        }

        function checkGruntKill(grunt, gruntGroup) {
            return gruntGroup.getChildIndex(grunt);
        }

        /*function killAllEnemyBullets() {
            if (aimGruntWeapons.length > 0) {
                for (var i = 0; i < aimGruntWeapons.length; i++) {
                    aimGruntWeapons[i].killAll();
                }
            }
            if (straightGruntWeapons.length > 0) {
                for (var j = 0; j < straightGruntWeapons.length; i++) {
                    straightGruntWeapons[j].killAll();
                }
            }
            if (rotateGruntWeapons.length > 0) {
                for (var k = 0; k < rotateGruntWeapons.length; i++) {
                    rotateGruntWeapons[k].killAll();
                }
            }
        }*/
        // Stage 01
        function startStageOne() {
            switch(gameTimer) {
                case 200:
                    spawnStraightGrunt(256, 10, 0, enemyStats.gruntStraightVelocity, 'gruntStraightBlue', 'straightGruntShot');
                    break;
                case 250:
                    spawnStraightGrunt(128, 10, 0, enemyStats.gruntStraightVelocity, 'gruntStraightBlue', 'straightGruntShot');
                    spawnStraightGrunt(256, 10, 0, enemyStats.gruntStraightVelocity, 'gruntStraightBlue', 'straightGruntShot');
                    spawnStraightGrunt(384, 10, 0, enemyStats.gruntStraightVelocity, 'gruntStraightBlue', 'straightGruntShot');
                    break;
                case 320:
                    spawnAimGrunt(200, 10, 0, enemyStats.gruntStraightVelocity, 'gruntAimBlue', 'aimGruntShot');
                    spawnAimGrunt(312, 10, 0, enemyStats.gruntStraightVelocity, 'gruntAimBlue', 'aimGruntShot');
                default:
                    console.log(gameTimer);
                    break;
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="js/library/phaser.js"></script>
    <title>Title</title>
</head>
<body>
    <div id="container"></div>

    <script type="text/javascript">
        var game = new Phaser.Game(512, 600, Phaser.AUTO, 'container', {
            preload: preload,
            create: create,
            update: update
            //render: render
        });

        function preload() {
            game.load.image('stage01BG', './assets/Background/stage01blue.png');
            game.load.image('sanaeHurtbox', './assets/Player/playerHurtbox.png');
            game.load.image('sanae', './assets/Player/playerStand.png');
            game.load.image('aimGruntShot', './assets/Enemy/enemyBullets/aimGruntShot.png');
            game.load.image('straightGruntShot', './assets/Enemy/enemyBullets/straightGruntShot.png');
            game.load.image('rotateGruntShot', './assets/Enemy/enemyBullets/rotateGruntShot.png');
            game.load.image('gruntRotate', './assets/Enemy/gruntRotate.png')
            game.load.image('gruntStraightRed', './assets/Enemy/gruntStraightRed.png');
            game.load.image('gruntStraightBlue', './assets/Enemy/gruntStraightBlue.png');
            game.load.image('gruntAimRed', './assets/Enemy/gruntAimRed.png');
            game.load.image('gruntAimBlue', './assets/Enemy/gruntAimBlue.png');
            game.load.image('singlePrimary', './assets/Player/playerShotA.png');
            game.load.image('doublePrimary', './assets/Player/playerShotB.png');
            game.load.image('spreadPrimary', './assets/Player/secondaryShotALT.png');
            game.load.spritesheet('gruntDeathExplode', './assets/Enemy/gruntDeathExplosion2.png', 64, 65);
        }

        var playerStats = {
            score: 0,
            graze: 0,
            lives: 3,
            bomb: 2
        };
        var lifeText;
        var gameOverText;
        var gameTimer = 0;
        const playerPhysicsStats = {
            normalVelocity: 275,
            focusVelocity: 150
        };
        const enemyStats = {
            aimGruntHP: 10,
            straightGruntHP: 16,
            rotateGruntHP: 24,
            gruntXvelocity: 50,
            gruntYvelocity: 50,
            gruntStraightVelocity: 100,
            movingGruntStraightXVelocity: 75,
            movingGruntRotateXVelocity: 150,
            movingGruntRotateYVelocity: 200,
            reverseGruntRotateXVelocity: 300,
            reverseGruntRotateYVelocity: 500
        };
        const enemyWeapon = {
            gruntBulletSpeed: 250,
            gruntBulletFireRate: 500,
            gruntBulletAngleOffset: 90,
            aimGruntBulletAngleOffset: 0,
            gruntStraightBulletSpeed: 150, //100
            gruntStraightBulletFireRate: 850, //16 is the lowest and quickest possible
            movingGruntStraightBulletSpeed: 150,
            movingGruntStraightBulletFireRate: 600,
            gruntRotateBulletSpeed: 150,
            gruntRotateBulletFireRate: 50,
            gruntExplosiveRotateBulletSpeed: 100,
            gruntExplosiveRotateFireRate: 16
        };
        const weaponStats = {
            weapon1BulletSpeed: 850,
            weapon1BulletFireRate: 90,
            weapon1BulletAngleOffSet: 90,
            weapon1Damage: 4,
            weapon2Damage: 6
        };
        var rotateGruntTimers = [];
        var counterClockwiseShootID = [];

        var bg;
        var weapon1;
        var weapon2;
        var playerHurtbox;
        var playerSprite;
        var cursors;
        var fireButton;
        var focusButton;
        var aimGrunts;
        var straightGrunts;
        var rotateGrunts;
        var gruntDeaths;

        // Enemy Weapons
        var aimGruntWeapons = [];
        var aimGruntWeaponDIS = []; // Stands for Death Index Signals
        var rotateGruntWeapons = [];
        var rotateGruntWeaponDIS = [];
        var straightGruntWeapons = [];
        var straightGruntWeaponDIS = [];
        var aimGruntExplosionDIS = [];
        var rotateGruntExplosionDIS = [];
        var straightGruntExplosionDIS = [];


        // weapon.Bullets is a group
        function create() {
            // Scrolling Background
            bg = game.add.tileSprite(0, 0, 512, 600, 'stage01BG');

            // ___WEAPONS___

            // Single Shot
            weapon1 = game.add.weapon(30, 'singlePrimary');
            weapon1.bulletKillType = Phaser.Weapon.KILL_WORLD_BOUNDS;
            weapon1.bulletAngleOffset = weaponStats.weapon1BulletAngleOffSet;
            weapon1.bulletSpeed = weaponStats.weapon1BulletSpeed;
            weapon1.fireRate = weaponStats.weapon1BulletFireRate;
            weapon1.bullets.forEach(function(bullet) {
                bullet.damageAmount = weaponStats.weapon1Damage;
            });

            // Double Shot
            weapon2 = game.add.weapon(30, 'doublePrimary');
            weapon2.bulletKillType = Phaser.Weapon.KILL_WORLD_BOUNDS;
            weapon2.bulletAngleOffset = 90;
            weapon2.bulletSpeed = 850;
            weapon2.fireRate = 90;
            weapon2.bullets.forEach(function(bullet) {
               bullet.damageAmount = 5;
            });

            // Enemies
            aimGrunts = game.add.group();
            aimGrunts.enableBody = true;
            aimGrunts.physicsBodyType = Phaser.Physics.ARCADE;

            straightGrunts = game.add.group();
            straightGrunts.enableBody = true;
            straightGrunts.physicsBodyType = Phaser.Physics.ARCADE;

            rotateGrunts = game.add.group();
            rotateGrunts.enableBody = true;
            rotateGrunts.physicsBodyType = Phaser.Physics.ARCADE;

            // Player
            playerHurtbox = this.add.sprite((game.world.width/2), game.world.height - 150, 'sanaeHurtbox');
            playerHurtbox.health = 3;
            playerHurtbox.anchor.setTo(0.5);
            playerSprite = this.add.sprite((game.world.width/2), game.world.height - 150, 'sanae');
            playerSprite.health = 3;
            playerSprite.anchor.setTo(0.5);


            game.physics.arcade.enable(playerHurtbox);
            game.physics.arcade.enable(playerSprite);
            playerHurtbox.body.collideWorldBounds = true;
            playerHurtbox.body.setCircle(6, 1);
            playerSprite.body.collideWorldBounds = true;
            console.log('hitbox x: ' + playerHurtbox.body.x + ', y: ' + playerHurtbox.body.y + ', ' + 'offset' + playerHurtbox.offsetX + ', ' + playerHurtbox.offsetY);
            console.log('sprite x: ' + playerSprite.body.x + ', y: ' + playerSprite.body.y + ', ' + 'offset' + playerSprite.offsetX + ', ' + playerSprite.offsetY);

            // Weapon Tracking
            // -- Weapon on player
            weapon1.trackSprite(playerSprite, 0, -(playerSprite.height/2 + 27));
            weapon2.trackSprite(playerSprite, 0, -(playerSprite.height/2 + 27));

            // Setting Controls
            cursors = this.input.keyboard.createCursorKeys();
            fireButton = this.input.keyboard.addKey(Phaser.KeyCode.Z);
            focusButton = this.input.keyboard.addKey(Phaser.KeyCode.SHIFT);

            // Game Text
                // Lives
            lifeText = game.add.text(10, game.world.height - 30, 'Lives: ' + playerHurtbox.health, { font: '20px Arial', fill: '#FFF' });
            lifeText.render = function() {
                lifeText.text = 'Lives: ' + Math.max(playerHurtbox.health, 0);
            };
                // Game Over
            gameOverText = game.add.text(game.world.centerX, game.world.centerY, 'GAME OVER\nTo restart, refresh the browser', { font: '30px Arial', fill: '#fff'});
            gameOverText.anchor.setTo(0.5);
            gameOverText.visible = false;

            // Enemy Death
            gruntDeaths = game.add.group();
            gruntDeaths.enableBody = true;
            gruntDeaths.physicsBodyType = Phaser.Physics.ARCADE;
            gruntDeaths.createMultiple(30, 'gruntDeathExplode');
            gruntDeaths.setAll('anchor.x', 0.5);
            gruntDeaths.setAll('anchor.y', 0.5);
            gruntDeaths.forEach(function(explode) {
               explode.animations.add('gruntDeathExplode');
            });
        }

        function update() {
            playerSprite.sendToBack();
            playerHurtbox.sendToBack();
            bg.sendToBack();
            aimGrunts.callAll('bringToTop');
            straightGrunts.callAll('bringToTop');
            rotateGrunts.callAll('bringToTop');
            playerHurtbox.body.velocity.x = 0;
            playerHurtbox.body.velocity.y = 0;
            playerSprite.body.velocity.x = 0;
            playerSprite.body.velocity.y = 0;

            // Collision Checking
                // aimGrunts
            game.physics.arcade.overlap(playerHurtbox, aimGrunts, playerCollide, null, this);
            game.physics.arcade.overlap(weapon1.bullets, aimGrunts, bulletCollide, null, this);
            game.physics.arcade.overlap(weapon2.bullets, aimGrunts, bulletCollide, null, this);

                // straightGrunts
            game.physics.arcade.overlap(playerHurtbox, straightGrunts, playerCollide, null, this);
            game.physics.arcade.overlap(weapon1.bullets, straightGrunts, bulletCollide, null, this);

                // rotateGrunts
            game.physics.arcade.overlap(playerHurtbox, rotateGrunts, playerCollide, null, this);
            game.physics.arcade.overlap(weapon1.bullets, rotateGrunts, bulletCollide, null, this);

            // Check Enemy Bullet Collisions/Overlap
            checkGruntBulletOverlap(aimGruntWeapons);
            checkGruntBulletOverlap(straightGruntWeapons);
            checkGruntBulletOverlap(rotateGruntWeapons);

            checkControls();

            // Enemy Shooting
            gruntFireSprite(aimGrunts, aimGruntWeapons, aimGruntWeaponDIS);
            gruntStraightFire(straightGrunts, straightGruntWeapons, straightGruntWeaponDIS);
            gruntRotateFire(rotateGrunts, rotateGruntWeapons, rotateGruntWeaponDIS);

            // Scroll the bg
            bg.tilePosition.y += 2;

            // Check game over
            if (!playerHurtbox.alive && gameOverText.visible === false) {
                gameOverText.visible = true;
                var fadeInGameOver = game.add.tween(gameOverText);
                fadeInGameOver.to({alpha: 0.2}, 1000, Phaser.Easing.Quintic.Out, false, 0, -1, true);
                fadeInGameOver.start();
            }
            startStageOne();
            gameTimer++;
        }

        // DEBUGGING
        function render() {
            game.debug.body(playerHurtbox);
            aimGrunts.forEachAlive(renderGroup, this, 'rgba(255, 0, 0, 0.4)');
            straightGrunts.forEachAlive(renderGroup, this, 'rgba(255, 0, 0, 0.4)');
            rotateGrunts.forEachAlive(renderGroup, this, 'rgba(255, 0, 0, 0,4)');
            weapon1.bullets.forEachAlive(renderGroup, this, 'rgba(0, 0, 255, 0.4)');
            weapon2.bullets.forEachAlive(renderGroup, this, 'rgba(0, 0, 255, 0.4)');
        }

        function renderGroup(child, strColor) {
            game.debug.body(child, strColor);
        }
        // End DEBUGGING

        // Control Actions
        function checkControls() {
            if (focusButton.isDown) {
                playerHurtbox.bringToTop();
            }

            if (cursors.up.isDown && !focusButton.isDown) {
                if (playerSprite.body.y <= 0) {
                    playerHurtbox.body.velocity.y = 0;
                    playerHurtbox.body.y = 16;
                }
                else {
                    playerHurtbox.body.velocity.y = -(playerPhysicsStats.normalVelocity);
                    playerSprite.body.velocity.y = -(playerPhysicsStats.normalVelocity);
                }
            }
            else if (cursors.up.isDown && focusButton.isDown) {
                playerHurtbox.bringToTop();
                if (playerSprite.body.y <= 0) {
                    playerHurtbox.body.velocity.y = 0;
                    playerHurtbox.body.y = 16;

                }
                else {
                    playerHurtbox.body.velocity.y = -(playerPhysicsStats.focusVelocity);
                    playerSprite.body.velocity.y = -(playerPhysicsStats.focusVelocity);
                }
            }
            else if (cursors.down.isDown && !focusButton.isDown) {
                if (playerSprite.body.y >= 556) {
                    playerHurtbox.body.velocity.y = 0;
                    playerHurtbox.body.y = 572;
                }
                else {
                    playerHurtbox.body.velocity.y = playerPhysicsStats.normalVelocity;
                    playerSprite.body.velocity.y = playerPhysicsStats.normalVelocity;
                }
            }
            else if (cursors.down.isDown && focusButton.isDown) {
                playerHurtbox.bringToTop();
                if (playerSprite.body.y >= 556) {
                    playerHurtbox.body.velocity.y = 0;
                    playerHurtbox.body.y = 572;
                }
                else {
                    playerHurtbox.body.velocity.y = playerPhysicsStats.focusVelocity;
                    playerSprite.body.velocity.y = playerPhysicsStats.focusVelocity;
                }
            }

            if (cursors.left.isDown && !focusButton.isDown) {
                if (playerSprite.body.x <= 0) {
                    playerHurtbox.body.velocity.x = 0;
                    playerHurtbox.body.x = 6;
                }
                else {
                    playerHurtbox.body.velocity.x = -(playerPhysicsStats.normalVelocity);
                    playerSprite.body.velocity.x = -(playerPhysicsStats.normalVelocity);
                }
            }
            else if (cursors.left.isDown && focusButton.isDown) {
                playerHurtbox.bringToTop();
                if (playerSprite.body.x <= 0) {
                    playerHurtbox.body.velocity.x = 0;
                    playerHurtbox.body.x = 6;
                }
                else {
                    playerHurtbox.body.velocity.x = -(playerPhysicsStats.focusVelocity);
                    playerSprite.body.velocity.x = -(playerPhysicsStats.focusVelocity);
                }
            }
            else if (cursors.right.isDown && !focusButton.isDown) {
                if (playerSprite.body.x >= 486) {
                    playerHurtbox.body.velocity.x = 0;
                    playerHurtbox.body.x = 492;
                }
                else {
                    playerHurtbox.body.velocity.x = playerPhysicsStats.normalVelocity;
                    playerSprite.body.velocity.x = playerPhysicsStats.normalVelocity;
                }
            }
            else if (cursors.right.isDown && focusButton.isDown) {
                playerHurtbox.bringToTop();
                if (playerSprite.body.x >= 486) {
                    playerHurtbox.body.velocity.x = 0;
                    playerHurtbox.body.x = 492;
                }
                else {
                    playerHurtbox.body.velocity.x = playerPhysicsStats.focusVelocity;
                    playerSprite.body.velocity.x = playerPhysicsStats.focusVelocity;
                }
            }

            // Check amount of P and then fire appropriate weapon
            if (playerHurtbox.alive && fireButton.isDown) {
                weapon1.fire();
            }
        }

        function playerCollide(player, enemy) {
            console.log('enemy collide');
            player.damage(enemy.damageAmount);
            playerSprite.damage(enemy.damageAmount);
            lifeText.render();
            player.body.x = 250;
            player.body.y = 443.5;
            playerSprite.body.x = 243;
            playerSprite.body.y = 428;
            //var tempHp = player.health;
            //player.reset(game.world.width / 2, game.world.height - 150, player.health);
            console.log(player.health);
            console.log(playerSprite.health);
            if (aimGruntWeapons.length > 0) {
                for (var i = 0; i < aimGruntWeapons.length; i++) {
                    aimGruntWeapons[i].killAll();
                }
            }
            if (straightGruntWeapons.length > 0) {
                for (var j = 0; j < straightGruntWeapons.length; j++) {
                    //straightGruntWeapons[straightGruntWeaponDIS[i]].bullets.callAllExists('killAll', true);
                    straightGruntWeapons[j].killAll();
                }
            }
            if (rotateGruntWeapons.length > 0) {
                for (var k = 0; k < rotateGruntWeapons.length; k++) {
                    //rotateGruntWeapons[rotateGruntWeaponDIS[i]].bullets.callAllExists('killAll', true);
                    rotateGruntWeapons[k].killAll();

                }
            }
            /*if (playerDeathSignal.callCount < playerStats.lives && !player.alive) {
                player.revive(1);
                playerSprite.revive(1);
                playerSprite.sendToBack();
                player.sendToBack();
                playerSprite.moveUp();
                player.moveUp();
            }*/
            // game over screen here
        }

        // when sprite dies, its bullets linger and will still deal damage
        function bulletCollide(bullet, sprite) {
            if (bullet !== undefined) {
                bullet.kill();
                sprite.damage(bullet.damageAmount);
                if (sprite.health <= 0) {
                    var spriteDeathAnim = gruntDeaths.getFirstExists(false);
                    spriteDeathAnim.reset(sprite.body.x + sprite.body.halfWidth, sprite.body.y + sprite.body.halfHeight);
                    spriteDeathAnim.body.velocity.y = sprite.body.velocity.y;
                    spriteDeathAnim.alpha = 0.7;
                    spriteDeathAnim.play('gruntDeathExplode', 30, false, true);
                }
            }
        }

        function checkGruntBulletOverlap(gruntWeaponArray) {
            // if there is exists a grunt weapon in the aimGruntWeapons array (means that an enemy has spawned as well), then check collision for each weapon
            if (gruntWeaponArray.length > 0) {
                for (var i = 0; i < gruntWeaponArray.length; i++) {
                    //since its a group vs sprite, then first argument to gruntShotCollide is the sprite
                    if (gruntWeaponArray[i] != null) {
                        game.physics.arcade.overlap(gruntWeaponArray[i].bullets, playerHurtbox, gruntShotCollide, null, this);
                    }
                }
            }
        }

        function gruntShotCollide(player, bullet) {
            console.log('grunt bullet collide');
            player.damage(bullet.damageAmount);
            playerSprite.damage(bullet.damageAmount);
            lifeText.render();
            player.body.x = 250;
            player.body.y = 443.5;
            playerSprite.body.x = 243;
            playerSprite.body.y = 428;
            console.log(player.health);
            console.log(playerSprite.health);
            if (aimGruntWeapons.length > 0) {
                for (var i = 0; i < aimGruntWeapons.length; i++) {
                    aimGruntWeapons[i].killAll();
                }
            }
            if (straightGruntWeapons.length > 0) {
                for (var i = 0; i < straightGruntWeapons.length; i++) {
                    //straightGruntWeapons[straightGruntWeaponDIS[i]].bullets.callAllExists('killAll', true);
                    straightGruntWeapons[i].killAll();
                }
            }
            if (rotateGruntWeapons.length > 0) {
                for (var i = 0; i < rotateGruntWeapons.length; i++) {
                    //rotateGruntWeapons[rotateGruntWeaponDIS[i]].bullets.callAllExists('killAll', true);
                    rotateGruntWeapons[i].killAll();

                }
            }
            // start gameover state here
        }

        // perfect now
        function spawnAimGrunt(x, y, velocityX, velocityY, spriteName, weaponName) {
            var newGrunt = aimGrunts.create(x, y, spriteName);
            newGrunt.anchor.setTo(0.5);
            newGrunt.outOfBoundsKill = true;
            newGrunt.checkWorldBounds = true;
            newGrunt.setHealth(enemyStats.aimGruntHP);
            newGrunt.damageAmount = 1;
            newGrunt.body.immovable = true;
            newGrunt.body.velocity.x = velocityX;
            newGrunt.body.velocity.y = velocityY;

            var newWeapon = game.add.weapon(30, weaponName);
            newWeapon.bulletSpeed = enemyWeapon.gruntBulletSpeed;
            newWeapon.bulletAngleOffset = enemyWeapon.aimGruntBulletAngleOffset;
            newWeapon.fireRate = enemyWeapon.gruntBulletFireRate;
            newWeapon.bullets.forEach(function(bullet) {
                bullet.damageAmount = 1;
            });
            newWeapon.trackSprite(newGrunt, 0, 0);
            aimGruntWeapons.push(newWeapon);
            aimGruntWeaponDIS.push(newGrunt.events.onKilled.add(checkGruntKill, this, this, aimGrunts));
        }

        // perfect now
        function spawnRotateGrunt(x, y, velocityX, velocityY, spriteName, weaponName, clockwise, explosive) {
            var newGrunt = rotateGrunts.create(x, y, spriteName);
            newGrunt.anchor.setTo(0.5);
            newGrunt.outOfBoundsKill = true;
            newGrunt.checkWorldBounds = true;
            newGrunt.setHealth(enemyStats.rotateGruntHP);
            newGrunt.damageAmount = 1;
            newGrunt.body.immovable = true;
            newGrunt.body.velocity.x = velocityX;
            newGrunt.body.velocity.y = velocityY;

            var newWeapon = game.add.weapon(80, weaponName);
            newWeapon.bulletAngleOffset = enemyWeapon.gruntBulletAngleOffset;
            if (explosive) {
                newGrunt.setHealth(4);
                newWeapon.bulletSpeed = enemyWeapon.gruntExplosiveRotateBulletSpeed;
                newWeapon.fireRate = enemyWeapon.gruntExplosiveRotateFireRate;
            }
            else {
                newWeapon.bulletSpeed = enemyWeapon.gruntRotateBulletSpeed;
                newWeapon.fireRate = enemyWeapon.gruntRotateBulletFireRate;
            }
            newWeapon.bullets.forEach(function(bullet) {
                bullet.damageAmount = 1;
            });
            newWeapon.trackSprite(newGrunt, 0, 0);
            rotateGruntWeapons.push(newWeapon);
            rotateGruntWeaponDIS.push(newGrunt.events.onKilled.add(checkGruntKill, this, this, rotateGrunts));
            rotateGruntTimers.push(0);
            if (clockwise) {
                counterClockwiseShootID.push(rotateGruntWeapons.length - 1);
            }
        }

        function spawnStraightGrunt(x, y, velocityX, velocityY, spriteName, weaponName, moving) {
            var newGrunt = straightGrunts.create(x, y, spriteName);
            newGrunt.anchor.setTo(0.5);
            newGrunt.outOfBoundsKill = true;
            newGrunt.checkWorldBounds = true;
            newGrunt.setHealth(enemyStats.straightGruntHP);
            newGrunt.damageAmount = 1;
            newGrunt.body.immovable = true;
            newGrunt.body.velocity.x = velocityX;
            newGrunt.body.velocity.y = velocityY;

            var newWeapon = game.add.weapon(30, weaponName);
            newWeapon.bulletAngleOffset = enemyWeapon.gruntBulletAngleOffset;
            if (moving) {
                newWeapon.bulletSpeed = enemyWeapon.movingGruntStraightBulletSpeed;
                newWeapon.fireRate = enemyWeapon.movingGruntStraightBulletFireRate;
            }
            else {
                newWeapon.bulletSpeed = enemyWeapon.gruntStraightBulletSpeed;
                newWeapon.fireRate = enemyWeapon.gruntStraightBulletFireRate;
            }
            newWeapon.bullets.forEach(function(bullet) {
                bullet.damageAmount = 1;
            });
            newWeapon.trackSprite(newGrunt, 0, 0);
            straightGruntWeapons.push(newWeapon);
            straightGruntWeaponDIS.push(newGrunt.events.onKilled.add(checkGruntKill, this, this, straightGrunts));
        }

        // aimGruntFire
        function gruntFireSprite(gruntGroup, gruntWeaponArray, gruntWeaponDIS) {
            // if player is a live and aimGruntWeapons exist shoot every weapon at the player
            if (playerHurtbox.alive && gruntWeaponArray.length > 0) {
                for (var i = 0; i < gruntWeaponArray.length; i++) {
                    // shoot at player when self is healthy and its onKilled signal hasn't been called
                    if (gruntGroup.getChildAt(i).health > 0 && gruntWeaponDIS[i].callCount <= 0) {
                        gruntWeaponArray[i].fireAtSprite(playerHurtbox);
                    }
                }
            }
        }

        // straightGruntFire
        function gruntStraightFire(gruntGroup, gruntWeaponArray, gruntWeaponDIS) {
            if (playerHurtbox.alive && gruntWeaponArray.length > 0) {
                for (var i = 0; i < gruntWeaponArray.length; i++) {
                    // shoot at player when self is healthy and its onKilled signal hasn't been called
                    if (gruntGroup.getChildAt(i).health > 0 && gruntWeaponDIS[i].callCount <= 0) {
                        //gruntWeaponArray[i].fire(null, gruntGroup.getChildAt(i).body.x + 22, game.world.height);
                        gruntWeaponArray[i].fireAngle = 90;
                        //gruntWeaponArray[i].bullets.setAll('body.velocity.x', 0);
                        gruntWeaponArray[i].fire();
                    }
                }
            }
        }

        // rotateGruntFire
        function gruntRotateFire(gruntGroup, gruntWeaponArray, gruntWeaponDIS) {
            if (playerHurtbox.alive && gruntWeaponArray.length > 0) {
                for (var i = 0; i < gruntWeaponArray.length > 0; i++) {
                    if (gruntGroup.getChildAt(i).health > 0 && gruntWeaponDIS[i].callCount <= 0) {
                        //gruntWeaponArray[i].fire(null, gruntGroup.getChildAt(i).body.x + 22, game.world.height);
                        //console.log('first fire x velocity: ' + gruntWeaponArray[i].bullets.getFirstAlive().body.velocity.x);
                        if (rotateGruntTimers[i] == 0) {
                            gruntWeaponArray[i].fire();
                            rotateGruntTimers[i] = game.time.now + gruntWeaponArray[i].fireRate;
                        }
                        if (game.time.now > rotateGruntTimers[i]) {
                            gruntWeaponArray[i].fire();
                            rotateGruntTimers[i] = game.time.now + gruntWeaponArray[i].fireRate;
                            if (counterClockwiseShootID.length > 0) {
                                for (var j = 0; j < counterClockwiseShootID.length; j++) {
                                    if (i === counterClockwiseShootID[j]) {
                                        gruntWeaponArray[i].fireAngle -= 25;
                                    }
                                    else {
                                        gruntWeaponArray[i].fireAngle += 25;
                                    }
                                }
                            }
                            else {
                                gruntWeaponArray[i].fireAngle += 25;
                            }
                        }
                    }
                }
            }
        }

        function checkGruntKill(grunt, gruntGroup) {
            return gruntGroup.getChildIndex(grunt);
        }

        /*function killAllEnemyBullets() {
            if (aimGruntWeapons.length > 0) {
                for (var i = 0; i < aimGruntWeapons.length; i++) {
                    aimGruntWeapons[i].killAll();
                }
            }
            if (straightGruntWeapons.length > 0) {
                for (var j = 0; j < straightGruntWeapons.length; i++) {
                    straightGruntWeapons[j].killAll();
                }
            }
            if (rotateGruntWeapons.length > 0) {
                for (var k = 0; k < rotateGruntWeapons.length; i++) {
                    rotateGruntWeapons[k].killAll();
                }
            }
        }*/
        // Stage 01
        function startStageOne() {
            switch(gameTimer) {
                case 200:
                    spawnStraightGrunt(256, 10, 0, enemyStats.gruntStraightVelocity, 'gruntStraightBlue', 'straightGruntShot', false);
                    break;
                case 250:
                    spawnStraightGrunt(128, 10, 0, enemyStats.gruntStraightVelocity, 'gruntStraightBlue', 'straightGruntShot', false);
                    spawnStraightGrunt(256, 10, 0, enemyStats.gruntStraightVelocity, 'gruntStraightBlue', 'straightGruntShot', false);
                    spawnStraightGrunt(384, 10, 0, enemyStats.gruntStraightVelocity, 'gruntStraightBlue', 'straightGruntShot', false);
                    break;
                case 320:
                    spawnAimGrunt(200, 10, 0, enemyStats.gruntStraightVelocity, 'gruntAimBlue', 'aimGruntShot');
                    spawnAimGrunt(312, 10, 0, enemyStats.gruntStraightVelocity, 'gruntAimBlue', 'aimGruntShot');
                    break;
                case 550:
                    spawnStraightGrunt(500, 10, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot', true);
                    break;
                case 600:
                    spawnStraightGrunt(500, 10, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot', true);
                    break;
                case 620:
                    spawnStraightGrunt(10, 10, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    break;
                case 650:
                    spawnStraightGrunt(500, 10, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot', true);
                    break;
                case 670:
                    spawnStraightGrunt(10, 10, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    break;
                case 685:
                    spawnAimGrunt(128, 10, 0, enemyStats.gruntStraightVelocity, 'gruntAimRed', 'aimGruntShot');
                    spawnAimGrunt(384, 10, 0, enemyStats.gruntStraightVelocity, 'gruntAimBlue', 'aimGruntShot');
                    break;
                case 700:
                    spawnStraightGrunt(500, 10, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot', true);
                    break;
                case 720:
                    spawnStraightGrunt(10, 10, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    break;
                case 750:
                    spawnStraightGrunt(500, 10, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot', true);
                    break;
                case 770:
                    spawnStraightGrunt(10, 10, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    break;
                case 820:
                    spawnStraightGrunt(10, 10, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    break;
                case 870:
                    spawnRotateGrunt(50, 10, 0, enemyStats.gruntStraightVelocity, 'gruntRotate', 'rotateGruntShot', true, false);
                    break;
                case 950:
                    spawnRotateGrunt(462, 10, 0, enemyStats.gruntStraightVelocity, 'gruntRotate', 'rotateGruntShot', false, false);
                    break;
                case 1150:
                    spawnRotateGrunt(500, 100, -enemyStats.movingGruntStraightXVelocity, 0, 'gruntRotate', 'rotateGruntShot', true, false);
                    break;
                case 1170:
                    spawnRotateGrunt(500, 100, -enemyStats.movingGruntStraightXVelocity, 0, 'gruntRotate', 'rotateGruntShot', true, false);
                    break;
                case 1210:
                    spawnRotateGrunt(500, 100, -enemyStats.movingGruntStraightXVelocity, 0, 'gruntRotate', 'rotateGruntShot', true, false);
                    break;
                case 1230:
                    spawnRotateGrunt(500, 100, -enemyStats.movingGruntStraightXVelocity, 0, 'gruntRotate', 'rotateGruntShot', true, false);
                    break;
                case 1500:
                    spawnRotateGrunt(480, 10, 0, 500, 'gruntRotate', 'rotateGruntShot', true, true);
                    spawnRotateGrunt(32, 10, 0, 500, 'gruntRotate', 'rotateGruntShot', false, true);
                    break;
                case 1600:
                    spawnRotateGrunt(448, 10, 0, 600, 'gruntRotate', 'rotateGruntShot', true, true);
                    spawnRotateGrunt(64, 10, 0, 600, 'gruntRotate', 'rotateGruntShot', false, true);
                    break;
                case 1700:
                    spawnRotateGrunt(416, 10, 0, 700, 'gruntRotate', 'rotateGruntShot', true, true);
                    spawnRotateGrunt(96, 10, 0, 700, 'gruntRotate', 'rotateGruntShot', false, true);
                    break;
                case 1800:
                    spawnRotateGrunt(384, 10, 0, 800, 'gruntRotate', 'rotateGruntShot', true, true);
                    spawnRotateGrunt(128, 10, 0, 800, 'gruntRotate', 'rotateGruntShot', false, true);
                    break;
                case 1900:
                    spawnRotateGrunt(224, 10, 0, 800, 'gruntRotate', 'rotateGruntShot', false, true);
                    spawnRotateGrunt(288, 10, 0, 800, 'gruntRotate', 'rotateGruntShot', true, true);
                    break;
                case 2150:
                    spawnAimGrunt(500, 40, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    spawnAimGrunt(500, 120, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    break;
                case 2300:
                    spawnAimGrunt(500, 40, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    spawnAimGrunt(500, 120, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    break;
                case 2450:
                    spawnAimGrunt(500, 40, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    spawnAimGrunt(500, 120, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    break;
                case 2600:
                    spawnAimGrunt(500, 40, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    spawnAimGrunt(500, 120, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    break;
                case 2750:
                    spawnAimGrunt(500, 40, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    spawnAimGrunt(500, 120, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    break;
                case 2800:
                    spawnAimGrunt(10, 40, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    spawnAimGrunt(10, 120, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    break;
                case 2900:
                    spawnAimGrunt(10, 40, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    spawnAimGrunt(10, 120, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    break;
                case 3000:
                    spawnAimGrunt(10, 40, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    spawnAimGrunt(10, 120, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    break;
                case 3100:
                    spawnAimGrunt(10, 40, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    spawnAimGrunt(10, 120, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntAimBlue', 'aimGruntShot');
                    break;
                case 3350:
                    spawnRotateGrunt(500, 590, -enemyStats.reverseGruntRotateXVelocity, -enemyStats.reverseGruntRotateYVelocity, 'gruntRotate', 'rotateGruntShot', true, false);
                    spawnRotateGrunt(10, 590, enemyStats.reverseGruntRotateXVelocity, -enemyStats.reverseGruntRotateYVelocity, 'gruntRotate', 'rotateGruntShot', false, false);
                    break;
                case 3550:
                    spawnRotateGrunt(500, 10, -enemyStats.reverseGruntRotateXVelocity, enemyStats.reverseGruntRotateYVelocity, 'gruntRotate', 'rotateGruntShot', true, false);
                    spawnRotateGrunt(10, 10, enemyStats.reverseGruntRotateXVelocity, enemyStats.reverseGruntRotateYVelocity, 'gruntRotate', 'rotateGruntShot', false, false);
                    break;
                case 3750:
                    spawnRotateGrunt(500, 590, -enemyStats.reverseGruntRotateXVelocity, -enemyStats.reverseGruntRotateYVelocity, 'gruntRotate', 'rotateGruntShot', true, false);
                    spawnRotateGrunt(10, 590, enemyStats.reverseGruntRotateXVelocity, -enemyStats.reverseGruntRotateYVelocity, 'gruntRotate', 'rotateGruntShot', false, false);
                    spawnStraightGrunt(10, 10, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    spawnStraightGrunt(500, 10, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    break;
                case 4050:
                    spawnStraightGrunt(10, 50, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    spawnStraightGrunt(500, 50, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot', true);
                    break;
                case 4100:
                    spawnStraightGrunt(10, 50, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    spawnStraightGrunt(500, 50, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot', true);
                    break;
                case 4150:
                    spawnStraightGrunt(10, 50, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    spawnStraightGrunt(500, 50, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot', true);
                    break;
                case 4200:
                    spawnStraightGrunt(10, 50, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    spawnStraightGrunt(500, 50, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot', true);
                    break;
                case 4250:
                    spawnStraightGrunt(10, 50, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    spawnStraightGrunt(500, 50, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot', true);
                    break;
                case 4300:
                    spawnStraightGrunt(10, 50, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    spawnStraightGrunt(500, 50, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot', true);
                    break;
                case 4350:
                    spawnStraightGrunt(10, 50, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    spawnStraightGrunt(500, 50, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot', true);
                    spawnRotateGrunt(128, 25, 0, enemyStats.movingGruntRotateYVelocity, 'gruntRotate', 'rotateGruntShot', true, true);
                    break;
                case 4400:
                    spawnStraightGrunt(10, 50, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    spawnStraightGrunt(500, 50, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot', true);
                    break;
                case 4450:
                    spawnStraightGrunt(10, 50, enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightBlue', 'straightGruntShot', true);
                    spawnStraightGrunt(500, 50, -enemyStats.movingGruntStraightXVelocity, enemyStats.gruntYvelocity, 'gruntStraightRed', 'straightGruntShot', true);
                    break;
                case 4650:
                    spawnRotateGrunt(384, 25, 0, enemyStats.movingGruntRotateYVelocity, 'gruntRotate', 'rotateGruntShot', false, true);
                    break;
                case 4750:
                    //tween fade into black and then out to new background
                    break;
                default:
                    console.log(gameTimer);
                    break;
            }
        }
    </script>
</body>
</html>